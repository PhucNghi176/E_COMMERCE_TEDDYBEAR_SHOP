FROM mcr.microsoft.com/dotnet/sdk:8.0-alpine AS build-env

WORKDIR /src
# Copy solution file
COPY *.sln ./

# Copy COMMAND project files
COPY AUTHORIZATION/AUTHORIZATION.API/*.csproj AUTHORIZATION/AUTHORIZATION.API/
COPY AUTHORIZATION/AUTHORIZATION.APPLICATION/*.csproj AUTHORIZATION/AUTHORIZATION.APPLICATION/
COPY AUTHORIZATION/AUTHORIZATION.INFRASTRUCTURE/*.csproj AUTHORIZATION/AUTHORIZATION.INFRASTRUCTURE/
COPY AUTHORIZATION/AUTHORIZATION.PERSISTENCE/*.csproj AUTHORIZATION/AUTHORIZATION.PERSISTENCE/
COPY AUTHORIZATION/AUTHORIZATION.PRESENTATION/*.csproj AUTHORIZATION/AUTHORIZATION.PRESENTATION/
COPY AUTHORIZATION/AUTHORIZATION.CONTRACT/*.csproj AUTHORIZATION/AUTHORIZATION.CONTRACT/

# Copy the shared CONTRACT project (now accessible)
COPY CONTRACT/CONTRACT/*.csproj CONTRACT/CONTRACT/
COPY COMMAND/COMMAND.INFRASTRUCTURE/*.csproj COMMAND/COMMAND.INFRASTRUCTURE/
COPY COMMAND/COMMAND.INFRASTRUCTURE/*.csproj COMMAND/COMMAND.INFRASTRUCTURE/
COPY COMMAND/COMMAND.PERSISTENCE/*.csproj COMMAND/COMMAND.PERSISTENCE/
COPY COMMAND/COMMAND.API/*.csproj COMMAND/COMMAND.API/
COPY COMMAND/COMMAND.CONTRACT/*.csproj COMMAND/COMMAND.CONTRACT/
COPY COMMAND/COMMAND.APPLICATION/*.csproj COMMAND/COMMAND.APPLICATION/
COPY COMMAND/COMMAND.PRESENTATION/*.csproj COMMAND/COMMAND.PRESENTATION/

# Restore packages with retry logic and timeout settings
RUN dotnet restore AUTHORIZATION/AUTHORIZATION.API/AUTHORIZATION.API.csproj

# Copy all source code
COPY . ./

# Build and publish the AUTHORIZATION API
WORKDIR /src/AUTHORIZATION/AUTHORIZATION.API
RUN dotnet publish -c Release -o /app/out --no-restore

# Runtime stage
FROM mcr.microsoft.com/dotnet/aspnet:8.0-alpine
WORKDIR /app
COPY --from=build-env /app/out .
ENTRYPOINT ["dotnet", "AUTHORIZATION.API.dll"]
